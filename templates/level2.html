<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Level 2 Analysis Report - {{ make }} {{ model }}</title>
	</head>
	<body>
		<h1>{{ report_title }}</h1>
		<h3 class="footnote">Generated: {{ generated_at }}</h3>
		<section class="intro">
			<p class="criteria">{{ summary }}</p>
			<p class="overview">
				Building on Level 1 findings, this Level 2 report incorporates verified
				vehicle history data to evaluate warranty coverage, accident severity,
				title status, and other long-term risk factors influencing fair value.
			</p>
			<p class="footnote">
				Only vehicles with a Carfax report have been analyzed.
			</p>
		</section>

		{{ valid_count }} listings were eligible for Level 2 analysis. Of those
		listings, <strong>{{ great_bin|length }}</strong> are considered a great
		deal, <strong>{{ good_bin|length }}</strong> are considered a good deal, and
		<strong>{{ fair_bin|length }}</strong> are considered a fair deal.
		<strong>Deals are sorted from best to worst.</strong>
		{% macro miles(n) -%}{{ "{:,}".format(n) }}{%- endmacro %}
		{% macro money(n) -%}{{ "${:,.0f}".format(n) }}{%- endmacro %}

		{% macro vehicle_row(rating) -%}
			<!-- 0: listing, 1: deal, 2: risk, 3: narrative -->
			{% set listing = rating[0] %}
			{% set deal = rating[1] %}
			{% set risk = rating[2] %}
			{% set narrative = rating[3] %}
			{% set last_line = narrative[-1] %}
			{% set is_downgraded = "downgraded" in last_line.lower() %}
			{% set seller_name = listing.seller.name if listing.seller.name else "N/A" %}
			{% set seller_location = listing.seller.location if listing.seller.location else "N/A" %}
			{% set vin = listing.vin %}
			{% set imgs = all_images.get(vin, []) %}

			<div class="image-viewer">
				{% for img in imgs %}
					<img src="{{ img }}" />
				{% endfor %}
			</div>

			<div class="listing-title">
				{{ listing.title }}
				{% if is_downgraded %}
					<span class="downgrade-tag">Downgraded</span>
				{% endif %}
				<a class="visor-link" href="{{ listing.visor_listing }}"
					>View on Visor ‚Üó</a
				>
			</div>

			<div class="listing-title-bar"></div>
			<div class="listing-specs compact-grid">
				<div class="listing-specs-item">VIN: <strong>{{ vin }}</strong></div>
				<div class="listing-specs-item">
					Mileage: <strong>{{ miles(listing.mileage) }}</strong>
				</div>
				<div class="listing-specs-item">
					Listing Price: <strong>{{ money(listing.price) }}</strong>
				</div>
				<div class="listing-specs-item">
					Risk Score: <strong>{{ risk }}</strong>
				</div>
				<div class="listing-specs-item">
					Dealer: <strong>{{ seller_name }} - {{ seller_location }}</strong>
				</div>
				<div class="listing-specs-item">
					<a class="dealer-link" href="{{ listing.dealer_listing }}"
						>View Dealer Listing ‚Üó</a
					>
				</div>
			</div>
			<div class="listing-notes">
				<strong>Notes:</strong>
				<ul>
					{% for line in narrative %}
						<li class="note-line">{{ line }}</li>
					{% endfor %}
				</ul>
			</div>
		{%- endmacro %}

		{% macro render_bin(emoji, title, cls, bin, skip_break) -%}
			{% if bin|length > 0 %}
				<h2 class="section-header {{ 'break-before' if not skip_break }}">
					{{ emoji }} {{ title }} Deals
				</h2>
				<div class="deal-bin">
					{% for rating in bin %}
						<div class="listing {{ cls }}">{{ vehicle_row(rating) }}</div>
					{% endfor %}
				</div>
			{% endif %}
		{%- endmacro %}
		<section>
			<!-- #region Deal Ratings -->
			{%
				set bins = [
					{"emoji":"üü¢","title":"Great","cls":"great-listing","bin":great_bin},
					{"emoji":"üîµ","title":"Good","cls":"good-listing","bin":good_bin},
					{"emoji":"üü°","title":"Fair","cls":"fair-listing","bin":fair_bin},
				]
			%}
			{# Calculate the first non-empty bin so we don't add unnecessary page breaks #}
			{# Must use as namespace in order for it to save value #}
			{% set state = namespace(first_nonempty_index=None) %}
			{% for b in bins %}
				{% if b.bin|length > 0 and state.first_nonempty_index is none %}
					{% set state.first_nonempty_index = loop.index0 %}
				{% endif %}
			{% endfor %}
			{# Display bins #}
			{% for b in bins %}
				{{ render_bin(b.emoji, b.title, b.cls, b.bin, loop.index0 == state.first_nonempty_index) }}
			{% endfor %}
			<div class="filtered-out">
				<div class="no-break">
					<h3>Filtered out:</h3>
					<div>
						üü† {{ poor_count }} Poor Deals, üî¥ {{ bad_count }} Bad Deals, üïµÔ∏è
						{{ sus_count }} Suspicious Deals
					</div>
				</div>
			</div>

			<!-- #endregion -->
		</section>
	</body>
	<footer>
		<div style="page-break-before: always;"></div>
		<div>
			<h2>Methodology</h2>
			<ul>
				<li>Listings must have an available Carfax report to qualify.</li>
				<li>
					Deal ratings are based on this order: local fair purchase price (FPP),
					national FPP, and then fair market value (FMV).
				</li>
				<li>
					Bin sizes change based on the available pricing data. For local FPP,
					we use the low and high market range to calculate bins. For national
					FPP and FMV, we default to a $2000 or 6% price spread, whichever is
					bigger.
				</li>
				<li>
					Risk scoring considers branded titles, accidents/damage and their
					severity, whether airbags were deployed, structural indicators,
					odometer deviations, miles driven, and warranty status.
				</li>
				<li>Risk can downgrade a deal to a lower value.</li>
				<li>
					Bad, Poor, and Suspicious deals are excluded from the main report.
				</li>
			</ul>
		</div>
		<div>
			<h2>Definitions and Clarifications</h2>
			<h4>Deal Bin/Pricing Calculations</h4>
			<p>
				When we search Kelley Blue Books for pricing data, we obtain 4 price
				amounts:
			</p>
			<ul>
				<li>
					MRSP, the factory-set price (which we do not use for calculations at
					this stage)
				</li>
				<li>
					National Fair Purchase Price (FPP), the average price this particular
					year and model are sold nationally
				</li>
				<li>Local Fair Purchase Price, which is based on your area</li>
				<li>
					Fair Market Value (FMV), which is the price this vehicle would be sold
					privately and not through a dealership
				</li>
			</ul>
			<p>
				We use the local FPP first, as it gives us a fair market range to work
				with. Using that range, we can calculate exactly what a Fair, Good, or
				Great deal will be. In the absence of a local FPP, we use the national
				FPP, but we must default to a set dollar amount for calculating deal
				strength. If that fails, we rely on FMV, following the same rules as the
				national FPP.
			</p>
			<p>
				These numbers will vary across years and trims, which is why they all
				have different bin and midpoint values.
			</p>

			<h4>Mileage Deviations</h4>
			<p>
				Mileage deviation refers to the amount of miles a vehicle has been
				driven more or less than the industry average of 15,000. This number is
				used by the US Government, Kelley Blue Books, and Carfax.
			</p>
			<h4>Structural indicators</h4>
			<p>
				When an impact occurs, there is always risk of structural issues. The
				greater the damage, the more chance there is a problem. We grade it on a
				scale, with minor damages slightly impacting this part of the risk, and
				major or severe damage impacting it greatly. This cannot be confirmed
				through a Carfax report, so an inspection is highly recommended.
			</p>
			<h4>Warranty Status</h4>
			<p>
				Warranty status only indicates the basic out-of-the-factory warranty.
				When an accident occurs, that warranty is usually voided. The lack of
				warranty does not impact the risk, but warranty still in place can lower
				the risk level.
			</p>
		</div>
	</footer>
</html>
