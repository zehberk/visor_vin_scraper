<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Level 2 Analysis Report - {{ make }} {{ model }}</title>
	</head>
	<body>
		<h1>{{ report_title }}</h1>
		<h3 class="footnote">Generated: {{ generated_at }}</h3>
		<section class="intro">
			{# <h3 class="section-label">Report Summary</h3> #}
			{# <hr /> #}
			<p class="criteria">{{ summary }}</p>
			<p class="overview">
				Building on Level 1 findings, this Level 2 report incorporates verified
				vehicle history data to evaluate warranty coverage, accident severity,
				title status, and other long-term risk factors influencing fair value.
			</p>
			<p class="footnote">
				Only vehicles with a Carfax report have been analyzed.
			</p>
		</section>

		{{ valid_count }} listings were eligible for Level 2 analysis,
		{{ total_count - valid_count }} were excluded due to missing reports. Of
		those listings, <strong>{{ great_bin|length }}</strong> are considered a
		great deal, <strong>{{ good_bin|length }}</strong> are considered a good
		deal, and <strong>{{ fair_bin|length }}</strong> are considered a fair deal.
		<strong>Deals are sorted from best to worst.</strong>
		{% macro miles(n) -%}{{ "{:,}".format(n) }}{%- endmacro %}
		{% macro money(n) -%}{{ "${:,.0f}".format(n) }}{%- endmacro %}

		{% macro vehicle_row(rating) -%}
			<!-- 0: listing, 1: deal, 2: risk, 3: narrative -->
			{% set listing = rating[0] %}
			{% set deal = rating[1] %}
			{% set risk = rating[2] %}
			{% set narrative = rating[3] %}
			{% set last_line = narrative[-1] %}
			{% set is_downgraded = "downgraded" in last_line.lower() %}
			{% set seller_name = listing.seller.name if listing.seller.name else "N/A" %}
			{% set seller_location = listing.seller.location if listing.seller.location else "N/A" %}

			<div class="listing-title">
				{{ listing.title }}
				{% if is_downgraded %}
					<span class="downgrade-tag">Downgraded</span>
				{% endif %}
				<a class="visor-link" href="{{ listing.visor_listing }}"
					>View on Visor ‚Üó</a
				>
			</div>

			<div class="listing-title-bar"></div>
			<div class="listing-specs compact-grid">
				<div class="listing-specs-item">
					VIN: <strong>{{ listing.vin }}</strong>
				</div>
				<div class="listing-specs-item">
					Mileage: <strong>{{ miles(listing.mileage) }}</strong>
				</div>
				<div class="listing-specs-item">
					Listing Price: <strong>{{ money(listing.price) }}</strong>
				</div>
				<div class="listing-specs-item">
					Risk Score: <strong>{{ risk }}</strong>
				</div>
				<div class="listing-specs-item">
					Dealer: <strong>{{ seller_name }} - {{ seller_location }}</strong>
				</div>
				<div class="listing-specs-item">
					<a class="dealer-link" href="{{ listing.dealer_listing }}"
						>View Dealer Listing ‚Üó</a
					>
				</div>
			</div>
			<div class="listing-notes">
				<strong>Notes:</strong>
				<ul>
					{% for line in narrative %}
						<li class="note-line">{{ line }}</li>
					{% endfor %}
				</ul>
			</div>
		{%- endmacro %}

		{% macro render_bin(emoji, title, cls, bin) -%}
			{% if bin|length > 0 %}
				<h2 class="section-header">{{ emoji }} {{ title }} Deals</h2>
				<div class="deal-bin">
					{% for rating in bin %}
						<div class="listing {{ cls }}">{{ vehicle_row(rating) }}</div>
					{% endfor %}
				</div>
			{% endif %}
		{%- endmacro %}
		<section>
			<!-- #region Deal Ratings -->
			{%
				set bins = [
					{"emoji":"üü¢","title":"Great","cls":"great-listing","bin":great_bin},
					{"emoji":"üîµ","title":"Good","cls":"good-listing","bin":good_bin},
					{"emoji":"üü°","title":"Fair","cls":"fair-listing","bin":fair_bin},
				]
			%}
			{% for b in bins %}
				{{ render_bin(b.emoji, b.title, b.cls, b.bin) }}
			{% endfor %}
			<div class="filtered-out">
				<div class="no-break">
					<h2>Filtered out:</h2>
					<div>
						üü† {{ poor_count }} Poor Deals, üî¥ {{ bad_count }} Bad Deals, üïµÔ∏è
						{{ sus_count }} Suspicious Deals
					</div>
				</div>
			</div>

			<!-- #endregion -->
		</section>
	</body>
	<footer>
		<div style="page-break-before: always;"></div>
		<div class="methodology">
			<h2>Methodology</h2>
			<ul>
				<li>Listings must have an available Carfax report to qualify.</li>
				<li>
					Deal ratings are based on this order: local fair purchase price (FPP),
					national FPP, and then fair market value (FMV).
				</li>
				<li>
					Bin sizes change based on the available pricing data. For local FPP,
					we use the low and high market range to calculate bins. For national
					FPP and FMV, we default to a $2000 or 6% price spread, whichever is
					bigger.
				</li>
				<li>
					Risk scoring considers branded titles, accidents/damage and their
					severity, whether airbags were deployed, structural indicators,
					odometer deviations, miles driven, and warranty status.
				</li>
				<li>Risk can downgrade a deal to a lower value.</li>
				<li>
					Bad, Poor, and Suspicious deals are excluded from the main report.
				</li>
			</ul>
		</div>
	</footer>
</html>
