<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Level 1 Analysis Report</title>
		<!-- #region CSS -->
		<style>
			@page {
				margin: 0.8in;
			}

			/* @page:first {
			margin-top: 0.5in;
			margin-bottom: 0.5in;
		} */

			body {
				font-family: "Segoe UI", Helvetica, Arial, sans-serif;
				font-size: 11pt;
				line-height: 1.5;
				color: #1e1e1e;
				/* dark gray, not pure black */
				background-color: #fff;
				margin: 0;
			}

			h1 {
				font-size: 20pt;
				font-weight: 600;
				margin-bottom: 0.6em;
				border-bottom: 2px solid #e5e5e5;
				/* lighter divider */
				padding-bottom: 0.3em;
			}

			h2 {
				font-size: 14pt;
				font-weight: 500;
				margin-top: 1.5em;
				margin-bottom: 0.6em;
				color: #333;
				page-break-before: avoid;
				page-break-after: avoid;
			}

			h3 {
				font-size: 12pt;
				font-weight: 400;
				margin-top: 1.5em;
				margin-bottom: 0.6em;
				color: #333;
				page-break-after: avoid;
				break-after: avoid-page;
			}

			main h3 {
				font-size: 12pt;
				font-weight: 500;
				border-left: 3px solid #0066cc;
				padding-left: 0.4em;
				color: #222;
			}

			footer h3 {
				font-size: 11pt;
				font-weight: 600; /* stronger than body but not overpowering */
				color: #444; /* darker than current #555 */
				border-bottom: 1px solid #ddd;
				padding-bottom: 0.2em;
				margin-top: 1.2em;
			}

			/* keep the heading+table as a unit */
			.table-block {
				page-break-inside: avoid;
				break-inside: avoid;
				margin-bottom: 1em;
			}

			/* clean, non-wrapping table that won‚Äôt split rows */
			table.matrix {
				width: 100%;
				border-collapse: collapse;
				table-layout: fixed;
				font-size: 10pt;
			}
			.matrix thead {
				display: table-header-group;
			} /* repeat header on new pages */
			.matrix tfoot {
				display: table-footer-group;
			}
			.matrix tr {
				page-break-inside: avoid;
				break-inside: avoid;
			}
			.matrix th,
			.matrix td {
				border: 1px solid #e5e5e5;
				padding: 6px 8px;
			}
			.matrix th {
				background: #fafafa;
				text-align: center;
			}
			.matrix td:first-child {
				text-align: left;
			}
			.matrix td {
				text-align: right;
			}
			ul {
				list-style-type: none;
				padding-left: 1em;
				margin: 0;
			}

			li {
				margin: 0.2em 0;
				padding: 0.2em 0.4em;
				border-radius: 4px;
				transition: background 0.2s ease;
				page-break-inside: avoid;
			}

			li:hover {
				background: #f5f5f5;
			}

			a {
				color: #0066cc;
				text-decoration: none;
				font-weight: 500;
			}

			a:hover {
				text-decoration: underline;
			}

			.bold-highlight {
				font-weight: bold;
				color: #222; /* darker than body text */
			}

			.timestamp {
				font-size: 9pt;
				font-style: italic;
				color: #666;
				margin-top: -0.5em;
				margin-bottom: 1em;
				font-weight: 400;
				border-left: 0;
				padding-left: 0;
			}

			.link-icon {
				color: #0066cc;
				font-size: 8pt;
				vertical-align: middle;
				margin-left: 0.2em;
			}

			.count {
				color: #666;
				margin-left: 0.4em;
			}

			.fmv {
				font-weight: 500;
				margin-left: 0.4em;
			}

			.trim-link {
				display: inline-flex;
				align-items: center;
				color: #0066cc;
				/* text-decoration: underline; */
				font-weight: 500;
			}

			.deal-bin {
				list-style-type: none;
				padding-left: 1em;
				margin: 0 0 1em 0;
			}

			.listing-title {
				display: block;
				font-size: 11pt;
				/* a touch bigger than body text */
				font-weight: 600;
				/* semi-bold to stand out */
				margin-bottom: 0.1em;
				/* tighter gap to details */
				color: #1a1a1a;
				/* darker than normal text */
			}

			.listing-details {
				display: block;
				font-size: 10pt;
				/* just a fraction smaller */
				color: #555;
				/* softer gray */
				margin-left: 1.5em;
				/* indent to show hierarchy */
				line-height: 1.4;
				/* balanced spacing */
			}

			footer {
				border-top: 2px solid #e5e5e5;
				margin-top: 2em;
				padding-top: 1em;
			}

			.note {
				font-weight: 500;
			}
		</style>
		<!--#endregion CSS -->
	</head>
	<body>
		<!-- #region Jinja Macros -->

		{% macro count_for_trim(trim, bins) -%}
			{%- set ns = namespace(total=0) -%}
			{%- for b in bins -%}
				{%-
					set n = b.listings
					| selectattr('title', 'equalto', trim)
					| list | length
				-%}
				{%- set ns.total = ns.total + n -%}
			{%- endfor -%}
			{{ ns.total }}
		{%- endmacro %}

		{% macro money(n) -%}{{ "${:,.0f}".format(n) }}{%- endmacro %}
		{% macro pct(n) -%}{{ (n|abs)|round(1) }}%{%- endmacro %}

		{% macro listing_row(listing, cache_entries) -%}
			{# prefer model fields; fall back to cache FMV if needed #}
			{% set compare_price  = listing.compare_price or cache_entries[listing.title].fmv %}
			{% set diff = listing.price_delta if listing.price_delta is not none else (listing.price - fmv) %}
			{% set p    = listing.deviation_pct if listing.deviation_pct is not none else ((diff / fmv) * 100) %}

			<span class="listing-title">
				#{{ listing.id }} ‚Ä¢ VIN: {{ listing.vin }} ‚Ä¢ {{ listing.condition }}
				{{ listing.title }}
				‚Ä¢ {{ listing.miles }} miles ‚Ä¢ {{ money(listing.price) }}
			</span>
			<span class="listing-details">
				{% if diff < 0 %}
					{{ money(-diff) }}
					({{ pct(p) }}) under market value ‚Ä¢
				{% elif diff > 0 %}
					{{ money(diff) }}
					({{ pct(p) }}) over market value ‚Ä¢
				{% else %}
					At market value ‚Ä¢
				{% endif %}
				Uncertainty: {{ listing.uncertainty }} ‚Ä¢ Risk: {{ listing.risk }}
			</span>
		{%- endmacro %}

		{% macro render_bin(emoji, title, bin, cache_entries) -%}
			<h2>{{ emoji }} {{ title }} Deals</h2>
			<ul class="deal-bin">
				{% for listing in bin.listings %}
					<li>{{ listing_row(listing, cache_entries) }}</li>
				{% endfor %}
			</ul>
		{%- endmacro %}

		<!-- #endregion -->

		<!-- #region Current Resale Values -->
		<h1>{{ report_title }}</h1>
		<h3 class="timestamp">Generated: {{ embedded_data["generated_at"] }}</h3>
		<main>
			<h2>
				Current Resale Values (MSRP / Fair Purchase Price / Fair Market Value)
			</h2>
			<ul>
				{% for visor_trim, trim_val in cache_entries.items() %}
					<li>
						<a class="trim-link" href="{{ trim_val.fmv_source }}">
							{{ trim_val.kbb_trim }}
							<span class="link-icon">üîó</span>
						</a>
						<span class="count"
							>({{ count_for_trim(visor_trim, [great_bin, good_bin, fair_bin, poor_bin, bad_bin]) }}
							listings)</span
						>
						<span class="fmv"
							>‚Äì {{ "${:,.0f}".format(trim_val.msrp) }} /
							{{ "${:,.0f}".format(trim_val.fpp) }} /
							{{ "${:,.0f}".format(trim_val.fmv) }}
						</span>
					</li>
				{% endfor %}
			</ul>
			<!-- #endregion -->

			<!-- #region Analysis Sections -->
			<h2>Analysis Highlights</h2>

			<!-- #region Bin Distribution -->
			<h3>Bin Distribution</h3>
			<ul>
				{% for b in analysis.deal_bins %}
					<li>
						<span class="bold-highlight">{{ b.category }}</span>: {{ b.count }}
						({{ b.percent_of_total|round(0) }}%),
						{% if b.avg_deviation_pct is not none %}
							avg {{ (b.avg_deviation_pct|abs)|round(0) }}%
							{% if b.avg_deviation_pct < 0 %}
								below
							{% else %}
								above
							{% endif %}
							comparison price (FPP/FMV)
						{% else %}
							n/a
						{% endif %}
					</li>
				{% endfor %}

				{% set rated_total = analysis.deal_bins | sum(attribute='count') %}
				{% set grand_total = rated_total + no_price_bin.count %}
				{% if no_price_bin.count > 0 %}
					<li>
						<span class="bold-highlight">{{ no_price_bin.category }}</span>:
						{{ no_price_bin.count }}
						({{ (no_price_bin.count / (grand_total if grand_total else 1) * 100) | round(0) }}%),
						avg n/a
					</li>
				{% endif %}
			</ul>
			<!-- #endregion -->

			<!-- #region Condition Distribution -->
			{% set cd = analysis.condition_distribution %}
			<div class="table-block">
				<h3>Deal √ó Condition Matrix</h3>
				<table class="matrix">
					<thead>
						<tr>
							<th>Bin</th>
							<th>New ({{ cd.New }})</th>
							<th>Certified ({{ cd.Certified }})</th>
							<th>Used ({{ cd.Used }})</th>
						</tr>
					</thead>
					<tbody>
						{% for bin, row in deal_condition_matrix.items() %}
							<tr>
								<td>{{ bin }}</td>
								<td>{{ row.New }}</td>
								<td>{{ row.Certified }}</td>
								<td>{{ row.Used }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			<!-- #endregion -->

			<h3>Trim Comparisons</h3>
			<h3>Risk & Uncertainty</h3>
			<h3>Negotiable Fair</h3>
			<h3>Anomalies</h3>
		</main>
		<!-- #endregion -->

		<hr />

		<!-- Deal Rating Sections -->
		{%
			set bins = [
			  {"emoji":"üü¢","title":"Great","bin":great_bin},
			  {"emoji":"üîµ","title":"Good","bin":good_bin},
			  {"emoji":"üü°","title":"Fair","bin":fair_bin},
			]
		%}
		{% for b in bins %}
			{{ render_bin(b.emoji, b.title, b.bin, cache_entries) }}
		{% endfor %}
		<h2>Filtered out:</h2>
		<ul class="deal-bin">
			<li>
				üü† {{ poor_bin.count }} Poor Deals, üî¥ {{ bad_bin.count }} Bad Deals, ‚ùî
				{{ no_price_bin.count }} No List Price
			</li>
		</ul>
	</body>
	<footer>
		<h2>Definitions and Explanations</h2>

		<h3>Resale Value Definitions</h3>
		<ul>
			<li>
				<span class="bold-highlight">
					MSRP (Manufacturer Suggested Retail Price):
				</span>
				This is the recommended price a manufacturer suggests for a retailer to
				sell its product.
			</li>
			<li>
				<span class="bold-highlight"> Fair Purchase Price (FPP): </span>
				KBB's estimate of what people are currently paying for a brand-new
				vehicle, based on recent transaction data and regional trends.
			</li>
			<li>
				<span class="bold-highlight"> Fair Markey Value (FMV): </span>
				KBB's estimate of what a vehicle is worth on the resale/used market,
				considering its age, mileage, condition, and demand.
			</li>
		</ul>
		<p>
			A way you can think of the difference is MSRP =
			<i>what a company wants you to pay for a new car</i>, FPP =
			<i>what buyers pay for a new car today</i>, and FMV =
			<i>what that same car is worth used</i>.
		</p>

		<h3>Deal Rating</h3>
		<p>
			Car listings are grouped into Great, Good, Fair, Poor, or Bad deals (this
			is called binning) based solely on price. We use a very basic formula:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">üü¢ Great: </span>$2,000+ or 7%+ under
				market value, whichever is larger
			</li>
			<li>
				<span class="bold-highlight">üîµ Good: </span>$1000‚Äì1999 or 3‚Äì7% under
				market value
			</li>
			<li>
				<span class="bold-highlight">üü° Fair: </span>within $1000 or 3% of
				market value
			</li>
			<li>
				<span class="bold-highlight">üü† Poor: </span>$1000‚Äì1999 or 3‚Äì7% over
				market value
			</li>
			<li>
				<span class="bold-highlight">üî¥ Bad: </span>$2,000+ or 7%+ over market
				value
			</li>
		</ul>
		<p>
			Listings that are considered Poor or Bad deals are rarely worth looking
			into because even with negotiation, they are unlikely to be more than a
			Fair deal.
			<br />
			<br />
			<span class="note">Note:</span> some listings do not have a price and so
			are unable to be rated. It is possible that the car has just entered the
			market and not been given a price, or that the dealer is waiting to see
			the interest level of buyers before committing to a price.
		</p>
		<h3>Uncertainty Rating:</h3>
		<p>
			Uncertainty is rated as Low, Some, or High, and is dependent on what
			documentation is readily available outside of the listing. For a level 1
			analysis, we look at whether a window sticker is available, if a CARFAX or
			AutoCheck report can be accessed, and if there is a warranty still active.
			Our formula for rating uncertainty is:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">High: </span>No documentation is available
			</li>
			<li>
				<span class="bold-highlight">Some: </span>A window sticker is present
				and the warranty is still active, but there is no auto report to review
			</li>
			<li>
				<span class="bold-highlight">Low: </span>There is an auto report that
				can be reviewed
			</li>
		</ul>
		<p>
			<br />
			<span class="note">Why this is important:</span>
			<br />
			These documents provide valuable data on confirming details on a vehicle.
			A window sticker can be used to cross-check specific add-ons that may be
			included in the listing mistakenly. An active warranty means that the car
			has likely not received any damage that could make the vehicle unsafe to
			drive. An auto report can help verify the title status of a car, how many
			owners it has had, and any reported damage.
			<br />
			<br />
			<span class="note">Note:</span> this data has been gathered at a very high
			level and may not reflect the full information for a vehicle. For example,
			a warranty may have expired due to age or being over mileage. Some cars
			are certified or have been repaired and may have extra warranties
			available to them.
		</p>
		<h3>Risk Rating:</h3>
		<p>
			At level 1, we define risk as a vehicle that could have maintenance issues
			or may be too good to be true. Risk is rated as Low, Some, or High, and is
			dependent on the listing price and the mileage of the vehicle. We
			calculate the "expected mileage" that this particular vehicle assuming
			that it was available for purchase on the first year that it was produced
			and that it would be driven 13,500 miles per year. The formula used for
			risk is:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">High: </span>the vehicle's mileage is more
				than 35% of what is expected, OR it is 20% over expected and the list
				price is 10%+ under current market value
			</li>
			<li>
				<span class="bold-highlight">Some: </span>the vehicle's mileage is more
				than 20% of what is expected OR the list price is 10%+ under current
				market value
			</li>
			<li>
				<span class="bold-highlight">Low: </span>price and mileage are within a
				normal range
			</li>
		</ul>
		<p>
			Deeper levels of analysis will change this basic rating from a 3-level
			scale to a numerical scale for more fine-tuned grading.
		</p>
		<!-- Embedded data that can be referenced later if necessary -->
		<!-- prettier-ignore -->
		<script type="application/json+jinja" id="raw-data">
            {{- embedded_data | tojson -}}
        </script>
	</footer>
</html>
