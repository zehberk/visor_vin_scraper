<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Level 1 Analysis Report</title>
	</head>
	<body>
		<!-- #region Jinja Macros -->

		{% macro count_for_trim(trim, bins) -%}
			{%- set ns = namespace(total=0) -%}
			{%- for b in bins -%}
				{%-
					set n = b.listings
					| selectattr('cache_key', 'equalto', trim)
					| list | length
				-%}
				{%- set ns.total = ns.total + n -%}
			{%- endfor -%}
			{{ ns.total }}
		{%- endmacro %}

		{% macro money(n) -%}{{ "${:,.0f}".format(n) }}{%- endmacro %}
		{% macro pct(n) -%}{{ ((n|abs) * 100.0) | round(1) }}%{%- endmacro %}

		{% macro listing_row(listing, cache_entries) -%}
			{# prefer model fields; fall back to cache FMV if needed #}
			{% set compare_price  = listing.compare_price or fallback_price %}
			{% set diff = listing.price_delta or (listing.price - compare_price) %}
			{% set p    = listing.deviation_pct or ((diff / compare_price)) %}

			<span class="listing-title">
				#{{ listing.id }} ‚Ä¢ VIN: {{ listing.vin }} ‚Ä¢ {{ listing.condition }}
				{{ listing.title }}
				‚Ä¢ {{ listing.miles }} miles ‚Ä¢ {{ money(listing.price) }}
			</span>
			<span class="listing-details">
				{% if diff < 0 %}
					{{ money(-diff) }}
					({{ pct(p) }}) under market value ‚Ä¢
				{% elif diff > 0 %}
					{{ money(diff) }}
					({{ pct(p) }}) over market value ‚Ä¢
				{% else %}
					At market value ‚Ä¢
				{% endif %}
				Uncertainty: {{ listing.uncertainty }} ‚Ä¢ Risk: {{ listing.risk }}
			</span>
		{%- endmacro %}

		{% macro render_bin(emoji, title, bin, cache_entries) -%}
			{% if bin.listings|length > 0 %}
				<h2>{{ emoji }} {{ title }} Deals</h2>
				<ul class="deal-bin">
					{% for listing in bin.listings %}
						<li>{{ listing_row(listing, cache_entries) }}</li>
					{% endfor %}
				</ul>
			{% endif %}
		{%- endmacro %}

		<!-- #endregion -->

		<h1>{{ report_title }}</h1>
		<h3 class="footnote">Generated: {{ generated_at }}</h3>
		<p>{{ summary }}</p>
		<main>
			<!-- #region Current Resale Values -->
			<h2>
				Current Resale Values (MSRP / Fair Purchase Price / Fair Market Value)
			</h2>
			<ul>
				{% for kbb_trim, trim_val in cache_entries.items() %}
					{% set listings_count = count_for_trim(trim_val.kbb_trim, [great_bin, good_bin, fair_bin, poor_bin, bad_bin, no_price_bin]) | int %}
					{% set fpp_values = [trim_val.fpp_local, trim_val.fpp_natl] | select('ne', 0) | list %}
					{% set fpp = (fpp_values | min if fpp_values else 0) %}
					{% set fmv = trim_val.fmv %}
					{% if listings_count > 0 %}
						<li>
							<a
								class="trim-link"
								href="{{ trim_val.local_source or trim_val.natl_source }}"
							>
								{{ trim_val.kbb_trim }}
								<span class="link-icon">üîó</span>
							</a>
							<span class="count"> ({{ listings_count }} listings) </span>
							<span class="fmv"
								>‚Äì {{ "${:,.0f}".format(trim_val.msrp) }}
								{% if fpp %}
									/ {{ "${:,.0f}".format(fpp) }}
								{% else %}
									/ (no FPP)
								{% endif %}
								{% if fmv %}
									/ {{ "${:,.0f}".format(fmv) }}
								{% else %}
									/ (no FMV)
								{% endif %}
							</span>
						</li>
					{% endif %}
				{% endfor %}
			</ul>
			<p>
				<i>
					{% if skip_messages %}
						<div class="skip-messages">
							<p>The following models have been skipped for these reasons:</p>
							<ul>
								{% for msg in skip_messages %}
									<li>- {{ msg }}</li>
								{% endfor %}
							</ul>
						</div>
					{% endif %}
				</i>
			</p>
			<!-- #endregion -->

			<!-- #region Analysis Sections -->
			<h2>Analysis Highlights</h2>

			<!-- #region Deal Distribution -->
			<h3>Deal Distribution</h3>
			<ul>
				{% for b in deal_bins %}
					<li>
						<span class="bold-highlight">{{ b.category }}</span>: {{ b.count }}
						({{ b.percent_of_total|round(0) }}%),
						{% if b.avg_deviation_pct is not none %}
							avg {{ pct(b.avg_deviation_pct) }}
							{% if b.avg_deviation_pct < 0 %}
								below
							{% elif b.avg_deviation_pct > 0 %}
								above
							{% else %}
								at
							{% endif %}
							comparison price (FPP/FMV)
						{% else %}
							n/a
						{% endif %}
					</li>
				{% endfor %}

				{% set rated_total = analysis.deal_bins | sum(attribute='count') %}
				{% set grand_total = rated_total + no_price_bin.count %}
				{% if no_price_bin.count > 0 %}
					<li>
						<span class="bold-highlight">{{ no_price_bin.category }}</span>:
						{{ no_price_bin.count }}
						({{ pct(no_price_bin.count / (grand_total if grand_total else 1)) }}),
						avg n/a
					</li>
				{% endif %}
			</ul>
			<!-- #endregion -->

			<!-- #region Condition Skew -->
			<h3>Condition Skew</h3>
			<ul>
				{% for bin in deal_bins %}
					<li>
						<span class="bold-highlight">{{ bin.category }}: </span>
						New: {{ bin.new_listings_count }} ({{ pct(bin.new_listings_pct) }}),
						Certified: {{ bin.certified_listings_count }}
						({{ pct(bin.certified_listings_pct) }}), Used:
						{{ bin.used_listings_count }} ({{ pct(bin.used_listings_pct) }})
					</li>
				{% endfor %}
			</ul>
			<!-- #endregion -->

			<!-- #region Deal x Condition Matrix -->
			{% set cd = analysis.condition_distribution %}
			<div class="table-block">
				<h3>Deal √ó Condition Matrix</h3>
				<table class="matrix">
					<thead>
						<tr>
							<th>Deal Rating</th>
							<th>New ({{ cd.New }})</th>
							<th>Certified ({{ cd.Certified }})</th>
							<th>Used ({{ cd.Used }})</th>
						</tr>
					</thead>
					<tbody>
						{% for bin, row in deal_condition_matrix.items() %}
							<tr>
								<td>{{ bin }} ({{ row.New + row.Certified + row.Used }})</td>
								<td>{{ row.New }}</td>
								<td>{{ row.Certified }}</td>
								<td>{{ row.Used }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			<!-- #endregion -->

			<!-- #region Deal Quality Mix -->
			<h3>Deal Quality Mix</h3>
			<ul>
				<li>
					<span class="bold-highlight">Good + Great:</span>
					{{ analysis.good_great_count }}
					({{ analysis.good_great_pct|round(0) }}%)
				</li>
				<li>
					<span class="bold-highlight">Fair:</span> {{ analysis.fair_count }}
					({{ analysis.fair_pct|round(0) }}%)
				</li>
				<li>
					<span class="bold-highlight">Poor + Bad:</span>
					{{ analysis.poor_bad_count }} ({{ analysis.poor_bad_pct|round(0) }}%)
				</li>
			</ul>

			<!-- #endregion -->

			<!-- #region Risk/Uncertainty Aggregation -->
			<h3>Risk & Uncertainty</h3>
			<ul>
				{% macro risk_count(level) -%}{{ all_listings | selectattr("risk", "equalto", level) | list | length }}{%- endmacro %}
				{% macro risk_pct(level) -%}
					{{ pct((all_listings | selectattr("risk", "equalto", level) | list | length) / (all_listings | length)) }}
				{%- endmacro %}
				{% macro uncertainty_count(level) -%}{{ all_listings | selectattr("uncertainty", "equalto", level) | list | length }}{%- endmacro %}
				{% macro uncertainty_pct(level) -%}
					{{ pct((all_listings | selectattr("uncertainty", "equalto", level) | list | length) / (all_listings | length)) }}
				{%- endmacro %}
				<li>
					<span class="bold-highlight">Risk</span> ‚Üí {{ risk_count("High") }}
					High ({{ risk_pct("High") }}), {{ risk_count("Some") }} Some
					({{ risk_pct("Some") }}), {{ risk_count("Low") }} Low
					({{ risk_pct("Low") }}), {{ risk_count("Unknown") }} Unknown
					({{ risk_pct("Unknown") }})
				</li>
				<li>
					<span class="bold-highlight">Uncertainty</span> ‚Üí
					{{ uncertainty_count("High") }} High ({{ uncertainty_pct("High") }}),
					{{ uncertainty_count("Some") }} Some ({{ uncertainty_pct("Some") }}),
					{{ uncertainty_count("Low") }} Low ({{ uncertainty_pct("Low") }})
				</li>
			</ul>
			<!-- #endregion -->

			<!-- #region Anomalies / Outliers -->
			<h3>Anomalies / Outlier Signals</h3>
			<p>
				These flags highlight unusually cheap opportunities, unstable pricing,
				and condition/price mismatches worth a second look.
			</p>
			{% set t = outliers.thresholds %}
			{% if outliers.strong_underpriced.count > 0 %}
				<p>
					<span class="bold-highlight">Strong Underpriced:</span>
					{{ outliers.strong_underpriced.count }} (‚â§ {{ t.under_pct|abs }}% below
					FMV/FPP)
					{% if outliers.strong_underpriced.examples %}
						<div class="example-lines">
							{% for ex in outliers.strong_underpriced.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}
			
			{% if outliers.strong_overpriced.count > 0 %}
				<p>
					<span class="bold-highlight">Strong Overpriced:</span>
					{{ outliers.strong_overpriced.count }} (‚â• {{ t.over_pct }}% above
					FMV/FPP)
					{% if outliers.strong_overpriced.examples %}
						<div class="example-lines">
							{% for ex in outliers.strong_overpriced.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}

			{% if outliers.cond_price_mismatch.count > 0 %}
				<p>
					<span class="bold-highlight">Condition / Price Mismatch:</span>
					{{ outliers.cond_price_mismatch.count }}
					{% if outliers.cond_price_mismatch.examples %}
						<div class="example-lines">
							{% for ex in outliers.cond_price_mismatch.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}


			{% if outliers.miles_price_tension.count > 0 %}
				<p>
					<span class="bold-highlight">Mileage / Price Tension:</span>
					{{ outliers.miles_price_tension.count }}
					{% if outliers.miles_price_tension.examples %}
						<div class="example-lines">
							{% for ex in outliers.miles_price_tension.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}
			
			{% if outliers.price_whiplash.count > 0 %}
				<p>
					<span class="bold-highlight">Price Whiplash:</span>
					{{ outliers.price_whiplash.count }} (‚â• {{ pct(t.drop_usd) }})
					{% if outliers.price_whiplash.examples %}
						<div class="example-lines">
							{% for ex in outliers.price_whiplash.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}
			
			{% if outliers.highrisk_bargains.count > 0 %}
				<p>
					<span class="bold-highlight">High-Risk Bargains:</span>
					{{ outliers.highrisk_bargains.count }}
					{% if outliers.highrisk_bargains.examples %}
						<div class="example-lines">
							{% for ex in outliers.highrisk_bargains.examples %}
								<div>‚Äî {{ ex }}</div>
							{% endfor %}
						</div>
					{% endif %}
				</p>
			{% endif %}

			<!-- #endregion -->
			<br />
			
			<!-- #endregion -->
		</main>

		<hr />

		<!-- #region Deal Ratings -->
		{%
			set bins = [
			  {"emoji":"üü¢","title":"Great","bin":great_bin},
			  {"emoji":"üîµ","title":"Good","bin":good_bin},
			  {"emoji":"üü°","title":"Fair","bin":fair_bin},
			]
		%}
		{% for b in bins %}
			{{ render_bin(b.emoji, b.title, b.bin, cache_entries) }}
		{% endfor %}
		<h2>Filtered out:</h2>
		<ul class="deal-bin">
			<li>
				üü† {{ poor_bin.count }} Poor Deals, üî¥ {{ bad_bin.count }} Bad Deals, ‚ùî
				{{ no_price_bin.count }} No List Price
			</li>
		</ul>

		<!-- #endregion -->
	</body>
	<footer>
		<!-- #region Definitions & Explanations -->
		<h2>Definitions and Explanations</h2>

		<h3>Resale Value Definitions</h3>
		<ul>
			<li>
				<span class="bold-highlight">
					MSRP (Manufacturer Suggested Retail Price):
				</span>
				This is the recommended price a manufacturer suggests for a retailer to
				sell its product.
			</li>
			<li>
				<span class="bold-highlight"> Fair Purchase Price (FPP): </span>
				KBB's estimate of what people are currently paying for a brand-new
				vehicle, based on recent transaction data and regional trends. KBB
				tracks both national and local prices (based on zip code). If a local
				value is unavailable, the national one will be provided and notated.
			</li>
			<li>
				<span class="bold-highlight"> Fair Market Value (FMV): </span>
				KBB's estimate of what a vehicle is worth on the resale/used market,
				considering its age, mileage, condition, and demand.
			</li>
		</ul>
		<p>
			A way you can think of the difference is 
			<ul>
				<li>MSRP = <i>what a company wants you to pay for a new car</i></li>
				<li>FPP = <i>what buyers pay for a new car today</i></li>
				<li>FMV = <i>what that same car is worth used</i></li>
			</ul>
		</p>

		<h3>Deal Rating</h3>
		<p>
			Car listings are grouped into Great, Good, Fair, Poor, or Bad deals (this
			is called binning) based solely on price. We use a very basic formula:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">üü¢ Great: </span>$2,000+ or 7%+ under
				market value, whichever is larger
			</li>
			<li>
				<span class="bold-highlight">üîµ Good: </span>$1000‚Äì1999 or 3‚Äì7% under
				market value
			</li>
			<li>
				<span class="bold-highlight">üü° Fair: </span>within $1000 or 3% of
				market value
			</li>
			<li>
				<span class="bold-highlight">üü† Poor: </span>$1000‚Äì1999 or 3‚Äì7% over
				market value
			</li>
			<li>
				<span class="bold-highlight">üî¥ Bad: </span>$2,000+ or 7%+ over market
				value
			</li>
		</ul>
		<p>
			If a local FPP has been found, we use the Fair Market Range to group the bins.
			<br />
			<br />
			Listings that are considered Poor or Bad deals are rarely worth looking
			into because even with negotiation, they are unlikely to be more than a
			Fair deal.
			<br />
			<br />
			<span class="note">Note:</span> some listings do not have a price and so
			are unable to be rated. It is possible that the car has just entered the
			market and not been given a price, or that the dealer is waiting to see
			the interest level of buyers before committing to a price.
		</p>
		<h3>Uncertainty Rating:</h3>
		<p>
			Uncertainty is rated as Low, Some, or High, and is dependent on what
			documentation is readily available outside of the listing. For a level 1
			analysis, we look at whether a window sticker is available, if a CARFAX or
			AutoCheck report can be accessed, and if there is a warranty still active.
			Our formula for rating uncertainty is:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">High: </span>No documentation is available
			</li>
			<li>
				<span class="bold-highlight">Some: </span>A window sticker is present
				and the warranty is still active, but there is no auto report to review
			</li>
			<li>
				<span class="bold-highlight">Low: </span>There is an auto report that
				can be reviewed
			</li>
		</ul>
		<p>
			<br />
			<span class="note">Why this is important:</span>
			<br />
			These documents provide valuable data on confirming details on a vehicle.
			A window sticker can be used to cross-check specific add-ons that may be
			included in the listing mistakenly. An active warranty means that the car
			has likely not received any damage that could make the vehicle unsafe to
			drive. An auto report can help verify the title status of a car, how many
			owners it has had, and any reported damage.
			<br />
			<br />
			<span class="note">Note:</span> this data has been gathered at a very high
			level and may not reflect the full information for a vehicle. For example,
			a warranty may have expired due to age or being over mileage. Some cars
			are certified or have been repaired and may have extra warranties
			available to them.
		</p>
		<h3>Risk Rating:</h3>
		<p>
			At level 1, we define risk as a vehicle that could have maintenance issues
			or may be too good to be true. Risk is rated as Low, Some, or High, and is
			dependent on the listing price and the mileage of the vehicle. We
			calculate the "expected mileage" that this particular vehicle assuming
			that it was available for purchase on the first year that it was produced
			and that it would be driven 13,500 miles per year. The formula used for
			risk is:
		</p>
		<ul>
			<li>
				<span class="bold-highlight">High: </span>the vehicle's mileage is more
				than 35% of what is expected, OR it is 20% over expected and the list
				price is 10%+ under current market value
			</li>
			<li>
				<span class="bold-highlight">Some: </span>the vehicle's mileage is more
				than 20% of what is expected OR the list price is 10%+ under current
				market value
			</li>
			<li>
				<span class="bold-highlight">Low: </span>price and mileage are within a
				normal range
			</li>
		</ul>
		<p>
			Deeper levels of analysis will change this basic rating from a 3-level
			scale to a numerical scale for more fine-tuned grading.
		</p>
		<h3>Anomalies and Outlier Signals</h3>
		<p>
			These flags highlight unusually cheap opportunities, unstable pricing, and
			condition/price mismatches worth a second look.
		</p>
		<ul>
			<li>
				<span class="bold-highlight">Strong Underpiced</span> ‚Äî Listings priced
				far below benchmark (FMV for used and certified, FPP for new). Default
				deviation: ‚â§ {{ outliers.thresholds.under_pct }}%.
				<br />
				<span class="count">
					<i>Why it matters:</i> potential fast wins; verify title/options.
				</span>
			</li>
			<li>
				<span class="bold-highlight">Strong Overpiced</span> ‚Äî Listings priced
				far above benchmark. Default deviation: ‚â•
				{{ outliers.thresholds.over_pct }}%.
				<br />
				<span class="count">
					<i>Why it matters:</i> sets a ‚Äúdon't pay above this‚Äù ceiling; exposes
					bad comps.
				</span>
			</li>
			<li>
				<span class="bold-highlight">Condition / Price Mismatch</span> ‚Äî Price
				doesn't match condition expectations. Defaults: Certified with deviation
				‚â§ -7%; or New priced < 95% of FPP; or Certified but rated Bad.
				<br />
				<span class="count">
					<i>Why it matters:</i> uncommon combo; opportunity or data issue.
				</span>
			</li>
			<li>
				<span class="bold-highlight">Mileage / Price Tension</span> ‚Äî Mileage
				signal conflicts with price signal. Defaults: Low miles (‚â§ 15th pct) yet
				deviation ‚â§ 0%; or High miles (‚â• 85th pct) yet deviation ‚â• 0%.
				<br />
				<span class="count">
					<i>Why it matters:</i> price ignores usage; re-check valuation.
				</span>
			</li>
			<li>
				<span class="bold-highlight">Price Whiplash</span> ‚Äî Unusually large
				recent price move. Default: |price_delta| ‚â• 7.0% since last check.
				<br />
				<span class="count">
					<i>Why it matters:</i> unstable listing.
				</span>
			</li>
			<li>
				<span class="bold-highlight">High-Risk Bargains</span> ‚Äî Cheap and
				flagged risky/uncertain. Defaults: (risk == High or uncertainty == High)
				and (deal = Great/Good or deviation ‚â§ -7%).
				<br />
				<span class="count">
					<i>Why it matters:</i> ‚Äútoo good to be true‚Äù; due diligence needed.
				</span>
			</li>
		</ul>

		<!-- #endregion -->

		<p class="attribution">
			Data for this report was retrieved from visor.vin and Kelley Blue Book
			(KBB). Automated analysis and summarization were performed with the
			assistance of ChatGPT (OpenAI).
		</p>

	</footer>
</html>
