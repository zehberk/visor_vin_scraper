<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Level 1 Analysis Report</title>
	<style>
		@page {
			margin: 0.8in;
		}

		/* @page:first {
			margin-top: 0.5in;
			margin-bottom: 0.5in;
		} */

		body {
			font-family: "Segoe UI", Helvetica, Arial, sans-serif;
			font-size: 11pt;
			line-height: 1.5;
			color: #1e1e1e;
			/* dark gray, not pure black */
			background-color: #fff;
			margin: 0;
		}

		h1 {
			font-size: 20pt;
			font-weight: 600;
			margin-bottom: 0.6em;
			border-bottom: 2px solid #e5e5e5;
			/* lighter divider */
			padding-bottom: 0.3em;
		}

		h2 {
			font-size: 14pt;
			font-weight: 500;
			margin-top: 1.5em;
			margin-bottom: 0.6em;
			color: #333;
			page-break-before: avoid;
			page-break-after: avoid;
		}

		h3 {
			font-size: 12pt;
			font-weight: 500;
			margin-top: 1.5em;
			margin-bottom: 0.6em;
			color: #333;
		}

		ul {
			list-style-type: none;
			padding-left: 1em;
			margin: 0;
		}

		li {
			margin: 0.2em 0;
			padding: 0.2em 0.4em;
			border-radius: 4px;
			transition: background 0.2s ease;
			page-break-inside: avoid;
		}

		li:hover {
			background: #f5f5f5;
		}

		a {
			color: #0066cc;
			text-decoration: none;
			font-weight: 500;
		}

		a:hover {
			text-decoration: underline;
		}

		.timestamp {
			font-size: 9pt;
			font-style: italic;
			color: #666;
			margin-top: -0.5em;
			margin-bottom: 1em;
		}

		.link-icon {
			color: #0066cc;
			font-size: 8pt;
			vertical-align: middle;
			margin-left: 0.2em;
		}

		.count {
			color: #666;
			margin-left: 0.4em;
		}

		.fmv {
			font-weight: 500;
			margin-left: 0.4em;
		}

		.trim-link {
			display: inline-flex;
			align-items: center;
			color: #0066cc;
			/* text-decoration: underline; */
			font-weight: 500;
		}

		.deal-bin {
			list-style-type: none;
			padding-left: 1em;
			margin: 0 0 1em 0;
		}

		.listing-title {
			display: block;
			font-size: 11pt;
			/* a touch bigger than body text */
			font-weight: 600;
			/* semi-bold to stand out */
			margin-bottom: 0.1em;
			/* tighter gap to details */
			color: #1a1a1a;
			/* darker than normal text */
		}

		.listing-details {
			display: block;
			font-size: 10pt;
			/* just a fraction smaller */
			color: #555;
			/* softer gray */
			margin-left: 1.5em;
			/* indent to show hierarchy */
			line-height: 1.4;
			/* balanced spacing */
		}

		footer {
			border-top: 2px solid #e5e5e5;
			margin-top: 2em;
			padding-top: 1em;
		}

		.note {
			font-weight: 500;
		}
	</style>
</head>

<body>
	{% macro count_for_trim(trim, bins) -%}
		{%- set ns = namespace(total=0) -%}
		{%- for b in bins -%}
			{%- set n = b.listings
					| selectattr('title', 'equalto', trim)
					| list | length -%}
			{%- set ns.total = ns.total + n -%}
		{%- endfor -%}
		{{ ns.total }}
	{%- endmacro %}
	<h1>{{ report_title }}</h1>
	<h3 class="timestamp">Generated: {{ embedded_data["generated_at"] }}</h3>

	<h2>Current Resale Values</h2>
	<ul>
		{% for visor_trim, trim_val in cache_entries.items() %}
		<li>
			<a class="trim-link" href="{{ trim_val.source }}">
				{{ trim_val.kbb_trim }}
				<span class="link-icon">üîó</span>
			</a>
			<span class="count">({{ count_for_trim(visor_trim, [great_bin, good_bin, fair_bin, poor_bin, bad_bin]) }} listings)</span>
			<span class="fmv">‚Äì {{ "${:,.0f}".format(trim_val.fmv) }}</span>
		</li>
		{% endfor %}
	</ul>

	<h2>Analysis Highlights</h2>
	<h3>Bin Distribution</h3>
	<h3>Trim Comparisons</h3>
	<h3>Risk & Uncertainty</h3>
	<h3>Negotiable Fair</h3>
	<h3>Anomalies</h3>

	<!-- Deal Rating Sections -->
	<h2>üü¢ Great Deals</h2>
	<ul class="deal-bin">
		{% for listing in great_bin.listings %}
		<li>
			{% set fmv = cache_entries[listing.title].fmv %}
			{% set diff = listing.price - fmv %}
			{% set pct = (diff / fmv * 100) | round(1) %}

			<span class="listing-title">
				#{{ listing.id }} ‚Ä¢
				VIN: {{ listing.vin }} ‚Ä¢
				{{ listing.title }} ‚Ä¢
				{{ listing.miles }} miles ‚Ä¢
				{{ "${:,.0f}".format(listing.price) }}
			</span>
			<span class="listing-details">
				{% if diff < 0 %} {{ "${:,.0f}" .format(-diff) }} ({{ -pct }}%) under market value ‚Ä¢ {% elif diff> 0
					%}
					{{ "${:,.0f}".format(diff) }} ({{ pct }}%) over market value ‚Ä¢
					{% else %}
					At market value ‚Ä¢
					{% endif %}
					Uncertainty: {{ listing.uncertainty }} ‚Ä¢
					Risk: {{ listing.risk }}
			</span>
		</li>
		{% endfor %}
	</ul>

	<h2>üîµ Good Deals</h2>
	<ul class="deal-bin">
		{% for listing in good_bin.listings %}
		<li>
			{% set fmv = cache_entries[listing.title].fmv %}
			{% set diff = listing.price - fmv %}
			{% set pct = (diff / fmv * 100) | round(1) %}

			<span class="listing-title">
				#{{ listing.id }} ‚Ä¢
				VIN: {{ listing.vin }} ‚Ä¢
				{{ listing.title }} ‚Ä¢
				{{ listing.miles }} miles ‚Ä¢
				{{ "${:,.0f}".format(listing.price) }}
			</span>
			<span class="listing-details">
				{% if diff < 0 %} {{ "${:,.0f}" .format(-diff) }} ({{ -pct }}%) under market value ‚Ä¢ {% elif diff> 0
					%}
					{{ "${:,.0f}".format(diff) }} ({{ pct }}%) over market value ‚Ä¢
					{% else %}
					At market value ‚Ä¢
					{% endif %}
					Uncertainty: {{ listing.uncertainty }} ‚Ä¢
					Risk: {{ listing.risk }}
			</span>
		</li>
		{% endfor %}
	</ul>

	<h2>üü° Fair Deals</h2>
	<ul class="deal-bin">
		{% for listing in fair_bin.listings %}
		<li>
			{% set fmv = cache_entries[listing.title].fmv %}
			{% set diff = listing.price - fmv %}
			{% set pct = (diff / fmv * 100) | round(1) %}

			<span class="listing-title">
				#{{ listing.id }} ‚Ä¢
				VIN: {{ listing.vin }} ‚Ä¢
				{{ listing.title }} ‚Ä¢
				{{ listing.miles }} miles ‚Ä¢
				{{ "${:,.0f}".format(listing.price) }}
			</span>
			<span class="listing-details">
				{% if diff < 0 %} {{ "${:,.0f}" .format(-diff) }} ({{ -pct }}%) under market value ‚Ä¢ {% elif diff> 0
					%}
					{{ "${:,.0f}".format(diff) }} ({{ pct }}%) over market value ‚Ä¢
					{% else %}
					At market value ‚Ä¢
					{% endif %}
					Uncertainty: {{ listing.uncertainty }} ‚Ä¢
					Risk: {{ listing.risk }}
			</span>
		</li>
		{% endfor %}
	</ul>

	<h3>Filtered out:</h3>
	<ul class="deal-bin">
		<li>
			üü† {{ poor_bin.count }} Poor Deals,
			üî¥ {{ bad_bin.count }} Bad Deals,
			‚ùî {{ no_price_bin.count }} No List Price
		</li>
	</ul>
</body>
<footer>
	<h2>Definitions and Explanations</h2>

	<h3>Deal Rating</h3>
	<p>
		Car listings are grouped into Great, Good, Fair, Poor, or Bad deals (this is called binning) based solely on price. We use a very basic formula:
		<ul>
			<li>Great: $2,000+ or 7%+ under market value, whichever is larger</li>
			<li>Good: $1000‚Äì1999 or 3‚Äì7% under market value</li>
			<li>Fair: within $1000 or 3% of market value</li>
			<li>Poor: $1000‚Äì1999 or 3‚Äì7% over market value</li>
			<li>Bad: $2,000+ or 7%+ over market value</li>
		</ul>
		Listings that are considered Poor or Bad deals are rarely worth looking into because even with negotiation, they are unlikely to be more than a Fair deal.
		<br><br>
		<span class="note">Note:</span> some listings do not have a price and so are unable to be rated. It is possible that the car has just
		entered the market and not been given a price, or that the dealer is waiting to see the interest level of buyers before committing to a price.
	</p>

	<h3>Uncertainty Rating:</h3>
	<p>
		Uncertainty is rated as Low, Some, or High, and is dependent on what documentation is readily available outside of the listing. For a level 1
		analysis, we look at whether a window sticker is available, if a CARFAX or AutoCheck report can be accessed, and if there is a warranty still
		active. Our formula for rating uncertainty is:
		<ul>
			<li>High: No documentation is available</li>
			<li>Some: A window sticker is present and the warranty is still active, but there is no auto report to review</li>
			<li>Low: There is an auto report that can be reviewed</li>
		</ul>
		<br>
		<span class="note">Why this is important:</span><br>
		These documents provide valuable data on confirming details on a vehicle. A window sticker can be used to cross-check specific
		add-ons that may be included in the listing mistakenly. An active warranty means that the car has likely not received any damage
		that could make the vehicle unsafe to drive. An auto report can help verify the title status of a car, how many owners it has
		had, and any reported damage.
		<br><br>
		<span class="note">Note:</span> this data has been gathered at a very high level and may not reflect the full information for a vehicle.
		For example, a warranty may have expired due to age or being over mileage. Some cars are certified or have been repaired and may have
		extra warranties available to them.
	</p>

	<h3>Risk Rating:</h3>
	<p>		
		At level 1, we define risk as a vehicle that could have maintenance issues or may be too good to be true. Risk is rated as Low, Some,
		or High, and is dependent on the listing price and the mileage of the vehicle. We calculate the "expected mileage" that this particular
		vehicle assuming that it was available for purchase on the first year that it was produced and that it would be driven 13,500 miles
		per year. The formula used for risk is:
		<ul>
			<li>High: the vehicle's mileage is more than 35% of what is expected, OR it is 20% over expected and the list price is 10%+ under current market value</li>
			<li>Some: the vehicle's mileage is more than 20% of what is expected OR the list price is 10%+ under current market value</li>
			<li>Low: price and mileage are within a normal range</li>
		</ul>
		Deeper levels of analysis will change this basic rating from a 3-level scale to a numerical scale for more fine-tuned grading.
	</p>

	<!-- Embedded data that can be referenced later if necessary -->
	<script type="application/json" id="raw-data">
		{{ embedded_data | tojson }}
	</script>
</footer>

</html>